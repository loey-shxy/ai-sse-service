/* empty css             *//* empty css                     *//* empty css              */import{d as J,a as K,t as X,r as k,S as oe,o as n,x as u,e,F as D,z as Z,y as C,f,b as P,i as H,s as ee,m as ne,u as g,n as O,A as M,C as N,E as A,Q as se,k as te,l as ae,p as ie,N as ce,T as le,w as re,c as Y,j as de,U as ue,V as _e,W as pe}from"./index--bHfDvFW.js";import{a as me,u as he,l as ve,b as fe,d as ge,r as ye,e as xe}from"./index-F5iSPcyE.js";/* empty css                  *//* empty css               */import{R as j,a as S}from"./constant-7OBoqEYa.js";import{A as $e,b as ke}from"./audioPlayer-YNfwgrAq.js";import{_ as Ce}from"./chat-model-info.vue_vue_type_script_setup_true_lang-YNtBLoUA.js";const G="/image/voice.png",Ee="/image/send.png",we={class:"chatting-records"},Ie={class:"chat-content scroll-bar"},Te={class:"chat-content__list"},Se={class:"message-popper"},Me={class:"message"},Ve={class:"mp3"},be=["onClick"],qe=["id"],Le=["src"],Be={class:"message-popper"},Pe={class:"message"},Ae={class:"mp3"},Re=["onClick"],Ue=["id"],De=["src"],He={class:"chat-content__list-message picture"},Oe={key:0,class:"chat-content__list-message reply"},Ne=e("div",{class:"message-popper"},[e("div",{class:"loading"},[e("div"),e("div"),e("div")])],-1),Fe=[Ne],ze={key:0,class:"chat-content__footer"},Qe={class:"form-wrap"},We=e("img",{src:Ee},null,-1),Ye=J({__name:"chatting-records",props:{model:{default:void 0},sessionId:{default:""},sessionChatList:{default:()=>[]}},emits:["refresh"],setup(F,{expose:a,emit:R}){const h=F,r=K({reqTxt:""}),p=X(()=>N()),y=ee(),V=d=>{p.value||y.push({name:"sign-in",query:{redirect:y.currentRoute.value.fullPath}});const i=document.getElementById(`audioRef${d}`);i==null||i.play()},w=k(!1),b=async()=>{if(r.reqTxt){if(!p.value){y.push({name:"sign-in",query:{redirect:y.currentRoute.value.fullPath}});return}if(r.reqTxt){h.sessionChatList.push({from:S.USER.v,type:j.VOICE.v,txt:r.reqTxt}),w.value=!0;const{code:d,data:i,msg:E}=await me({sessionId:h.sessionId,modelId:h.model.id,reqTxt:r.reqTxt});w.value=!1,d===1e3?(r.reqTxt="",h.sessionChatList.push(i.res),U(i.res.txt)):A({type:"error",message:E})}}},U=async d=>{var $;const i=new $e,c=($=(await fetch(`http://localhost:3000/say-prompt?prompt=${d}`)).body)==null?void 0:$.getReader();for(;c;){const{done:I,value:s}=await c.read();if(I)break;const _=ke(s);i.receiveAudioData(_)}},q=()=>{const d=document.getElementsByClassName("chat-content")[0];d.scrollTop=d.scrollHeight+10};return oe(q),a(q),(d,i)=>{const E=se,x=te,c=ae,$=ie,I=ne;return n(),u("div",we,[e("div",Ie,[e("div",Te,[(n(!0),u(D,null,Z(d.sessionChatList,(s,_)=>(n(),u(D,null,[s.type===g(j).VOICE.v?(n(),u("div",{key:_,class:O(["chat-content__list-message",s.from===g(S).MODEL.v?"reply":"send"])},[e("div",Se,[e("div",Me,[e("span",null,M(s.txt),1)]),e("div",Ve,[s.from===g(S).MODEL.v&&s.txtVoice?(n(),u("img",{key:0,src:G,onClick:L=>V(`${_}`)},null,8,be)):C("",!0),e("audio",{id:`audioRef${_}`,controls:"",hidden:""},[e("source",{src:s.txtVoice,type:"audio/mpeg"},null,8,Le)],8,qe)])])],2)):(n(),u("div",{key:_+"p",class:O(["chat-content__list-message",s.from===g(S).MODEL.v?"reply":"send"])},[e("div",Be,[e("div",Pe,M(s.txt||s.respTxt),1),e("div",Ae,[s.from===g(S).MODEL.v&&(s.txtVoice||s.respTxtVoice)?(n(),u("img",{key:0,src:G,onClick:L=>V(`${_}p`)},null,8,Re)):C("",!0),e("audio",{id:`audioRef${_}p`,controls:"",hidden:""},[e("source",{src:s.txtVoice||s.respTxtVoice,type:"audio/mpeg"},null,8,De)],8,Ue)])]),e("div",He,[f(E,{src:s.previewPath,fit:"cover","close-on-press-escape":"","hide-on-click-modal":"","preview-src-list":typeof s.sourcePath=="string"?[s.sourcePath]:s.sourcePath,lazy:""},null,8,["src","preview-src-list"])])],2))],64))),256)),w.value?(n(),u("div",Oe,Fe)):C("",!0)])]),d.sessionId?(n(),u("div",ze,[e("div",Qe,[f(I,{model:r,inline:"",onSubmit:H(b,["prevent"])},{default:P(()=>[f(c,{prop:"reqTxt"},{default:P(()=>[f(x,{modelValue:r.reqTxt,"onUpdate:modelValue":i[0]||(i[0]=s=>r.reqTxt=s),placeholder:"Type a message"},null,8,["modelValue"])]),_:1}),f(c,null,{default:P(()=>[f($,{type:"primary",onClick:b},{default:P(()=>[We]),_:1})]),_:1})]),_:1},8,["model"])])])):C("",!0)])}}}),je={class:"chat"},Ge={key:0,class:"model-list__wrap"},Je={class:"model-list__content"},Ke={class:"model-list scroll-bar"},Xe={class:"model-list__group"},Ze=["onClick"],es={class:"model-photo"},ss={class:"model-name"},ts={class:"model-name__name"},os={class:"model-name__message text-line-clamp text-line-clamp__1"},ns={class:"model-list__operation"},as=["onClick"],is=["onClick"],cs={class:"chat-content__wrap"},ls={class:"content-header"},ys=J({__name:"ai-chat",setup(F){const a=k(),R=k(""),{appContext:{config:{globalProperties:h}}}=de(),r=X(()=>N()),p=k([]),y=async()=>{r.value&&(p.value=await he()),a.value=V(),ve.isEmpty(a.value)||i(w(a.value))},V=()=>{var l;const t=q.query.id;if(t){const v=(l=p.value)==null?void 0:l.find(B=>B.model.id===t);return v&&t===v.model.id?(c.sessionId=v.id,v.model):b(t)}const o=p.value[p.value.length-1];return o&&o.model?o.model:{}},w=t=>{var o;return(o=p.value)==null?void 0:o.find(l=>l.model.id===t.id)},b=async t=>{const o=await fe({sessionId:"",modelId:t,newSession:1});r.value||(x.value=o.records);const l={id:o.sessionId,model:o.other};return p.value.push(l),a.value=o.other,c.sessionId=o.sessionId,o.other},U=k("100%"),q=ue();ce(async()=>{await y(),h.$isMobile||le(()=>{d()})});const d=()=>{const t=document.querySelector(".page-header"),o=document.querySelector(".page-footer"),l=(t==null?void 0:t.clientHeight)||0,v=(o==null?void 0:o.clientHeight)||0,T=document.documentElement.clientHeight;U.value=T-l-v+"px"},i=async t=>{a.value=t.model,c.sessionId=t.id,_.push({name:"chat",query:{id:t.model.id}})},E=k(0),x=k([]),c=K({page:1,sessionId:"",limit:1e4,sort:"asc"});re(()=>c,()=>{c.sessionId&&N()&&$()},{deep:!0});const $=async()=>{const t=await ge(c);x.value=t.records,E.value=t.total},I=async t=>{if(!r.value)return;const{code:o,msg:l}=await ye(t.id);o===1e3?y():A({type:"error",message:l})},s=t=>{r.value&&pe.confirm("Delete the session?","Warning",{confirmButtonText:"OK",cancelButtonText:"Cancel",type:"warning"}).then(async()=>{const{code:o,msg:l}=await xe(t.id);o===1e3?(A({type:"success",message:"Delete success"}),c.sessionId="",x.value=[],_.replace({name:"chat"}),y()):A({type:"warning",message:l})})},_=ee(),L=()=>{h.$isMobile&&_.push({name:"characters-detail",query:{model:JSON.stringify(a.value)}})};return(t,o)=>{var T,B,z;const l=te,v=se;return n(),u("div",je,[g(h).$isMobile?C("",!0):(n(),u("div",Ge,[e("div",Je,[f(l,{modelValue:R.value,"onUpdate:modelValue":o[0]||(o[0]=m=>R.value=m),placeholder:"Search...","prefix-icon":g(_e)},null,8,["modelValue","prefix-icon"]),e("div",Ke,[e("div",Xe,[(n(!0),u(D,null,Z(p.value,m=>{var Q;return n(),u("div",{key:m.id,class:O(["model-list__item",((Q=a.value)==null?void 0:Q.id)===m.model.id&&"is-active"]),onClick:W=>i(m)},[e("div",es,[f(v,{src:m.model.headUrl,fit:"cover"},null,8,["src"])]),e("div",ss,[e("div",ts,M(m.model.name),1),e("div",os,M(m.model.desc),1)]),e("div",ns,[e("div",{class:"operation-icon refresh",onClick:H(W=>I(m),["stop"])},null,8,as),e("div",{class:"operation-icon delete",onClick:H(W=>s(m),["stop"])},null,8,is)])],10,Ze)}),128))])])])])),e("div",cs,[e("div",ls,[(T=a.value)!=null&&T.headUrl?(n(),Y(v,{key:0,src:(B=a.value)==null?void 0:B.headUrl,fit:"cover",onClick:L},null,8,["src"])):C("",!0),e("span",{onClick:L},M((z=a.value)==null?void 0:z.name),1)]),f(Ye,{model:a.value,"session-id":g(c).sessionId,"session-chat-list":x.value,onRefresh:$},null,8,["model","session-id","session-chat-list"])]),g(h).$isMobile?C("",!0):(n(),Y(Ce,{key:1,model:a.value},null,8,["model"]))])}}});export{ys as default};
